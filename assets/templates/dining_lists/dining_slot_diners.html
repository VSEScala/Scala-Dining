{% extends 'dining_lists/dining_slot.html' %}

{% load dining_tags %}

{% block tab_list %}active{% endblock %}

{% block details %}
    <p>
        <a href="{% url 'day_view' day=dining_list.date.day month=dining_list.date.month year=dining_list.date.year %}">
            ‚Üê Back to day view
        </a>
    </p>
    <ul class="list-group">
        {% for entry in entries %}
            <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        {{ entry.get_name }}
                        {# Contact info (only visible if signed up) #}
                        {% if show_contact_info and entry.is_internal %}
                            {% include 'snippets/contact_info_button.html' with user=entry.user id=entry.pk %}
                        {% endif %}
                    </span>
                    <span>
                        {# External badge #}
                        {% if entry.is_external %}
                            <span class="badge badge-secondary">External diner</span>
                        {% endif %}
                        {# Membership icons #}
                        {% if entry.is_internal %}
                            {% for membership in entry.user.get_verified_memberships %}
                                {% if membership.association.icon_image %}
                                    <i class="membership_icon">
                                            <img src="{{ membership.association.icon_image.url }}"
                                                 alt="{{ membership.association.slug }}">
                                        </i>
                                {% else %}
                                    <i>{{ membership.association.slug|slice:":1" }}</i>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </span>
                </div>
                {% if entry.is_internal and entry.user.dietary_requirements %}
                    <div class="text-warning mt-1">
                        <i class="fas fa-info-circle"></i> {{ entry.user.dietary_requirements }}
                    </div>
                {% endif %}
                <div class="mt-1">
                    {# Help stats #}
                    {% if can_edit_stats %}
                        {# Render as buttons #}
                        <form method="post" action="{% url 'slot_list' pk=dining_list.pk %}"
                              class="d-inline-block stats-form">
                            {% csrf_token %}
                            <input type="hidden" name="entry_id" value="{{ entry.pk }}">
                            <div class="btn-group btn-group-sm">
                                <button type="submit" name="action"
                                        value="shopped_{% if entry.has_shopped %}false{% else %}true{% endif %}"
                                        class="btn btn-sm {% if entry.has_shopped %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                    <i class="fas fa-shopping-bag"></i> Shopped
                                </button>
                                <button type="submit" name="action"
                                        value="cooked_{% if entry.has_cooked %}false{% else %}true{% endif %}"
                                        class="btn btn-sm {% if entry.has_cooked %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                    <i class="fas fa-utensils"></i> Cooked
                                </button>
                                <button type="submit" name="action"
                                        value="cleaned_{% if entry.has_cleaned %}false{% else %}true{% endif %}"
                                        class="btn btn-sm {% if entry.has_cleaned %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                    <i class="fas fa-soap"></i> Cleaned
                                </button>
                            </div>
                        </form>
                    {% else %}
                        {# Render as badges #}
                        {% if entry.has_shopped %}
                            <span class="badge badge-info"><i class="fas fa-shopping-bag"></i> Shopped</span>
                        {% endif %}
                        {% if entry.has_cooked %}
                            <span class="badge badge-info"><i class="fas fa-utensils"></i> Cooked</span>
                        {% endif %}
                        {% if entry.has_cleaned %}
                            <span class="badge badge-info"><i class="fas fa-soap"></i> Cleaned</span>
                        {% endif %}
                    {% endif %}
                    {# Delete button #}
                    {% if entry|can_delete_entry:user %}
                        <form method="post" action="{% url "entry_delete" pk=entry.pk %}" class="d-inline-block">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i>
                                <span class="sr-only">Delete entry</span>
                            </button>
                        </form>
                    {% endif %}
                </div>
            </li>
        {% endfor %}
    </ul>
    {# Script for remembering the scroll position whenever stats are changed #}
    <script>
        function storeScroll() {
            /**
             * Saves current scroll position.
             */
            sessionStorage.setItem('scroll', window.scrollY.toString());
        }

        function restoreScroll() {
            /**
             * Scrolls to a saved position, if any.
             */
            let scroll = sessionStorage.getItem('scroll');
            if (scroll) {
                window.scroll(0, parseFloat(scroll));
            }
            sessionStorage.removeItem('scroll');
        }

        document.addEventListener('DOMContentLoaded', function() {
            restoreScroll();
            document.querySelectorAll('.stats-form').forEach(function(form) {
                form.addEventListener('submit', storeScroll);
            });
        });
    </script>
{% endblock details %}
